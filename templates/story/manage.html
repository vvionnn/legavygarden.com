{% extends "base.html" %}
{% block title %}My Stories - Legacy Garden{% endblock %}

{% block content %}
<style>
:root {
    --lg-green-dark: #2E7D32;
    --lg-green-btn: #43A047;
    --lg-red-btn: #E53935;
    --lg-blue-btn: #1E88E5;
    --lg-bg-beige: #F9F5F0; 
}

/* Page Background Wrapper */
.manage-wrapper {
    background-color: var(--lg-bg-beige);
    min-height: 85vh;
    padding: 40px 0;
}

/* HEADER */
.page-title {
    color: var(--lg-green-dark);
    font-weight: 800;
    font-size: 2rem;
    margin-bottom: 5px;
}
.page-subtitle {
    color: #666;
    font-size: 1rem;
    margin-bottom: 30px;
}

/* TABS */
.nav-pills {
    gap: 15px;
    margin-bottom: 30px;
    border-bottom: 1px solid #e0e0e0;
    padding-bottom: 20px;
}
.nav-pills .nav-link {
    border-radius: 50px;
    padding: 8px 24px;
    font-weight: 700;
    color: #555;
    background: white;
    border: 1px solid #ddd;
    transition: all 0.2s;
}
.nav-pills .nav-link.active {
    background-color: var(--lg-green-dark);
    color: white;
    border-color: var(--lg-green-dark);
}
.nav-pills .nav-link:hover:not(.active) {
    background-color: #f1f1f1;
}

/* CARDS */
.story-manage-card {
    background: white;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid #eee;
    display: flex;
    gap: 20px;
    align-items: flex-start;
    box-shadow: 0 4px 10px rgba(0,0,0,0.03);
    transition: transform 0.2s;
}
.story-manage-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.06);
}

/* THUMBNAIL IMAGE */
.card-thumb {
    width: 160px;
    height: 120px;
    object-fit: cover;
    border-radius: 12px;
    flex-shrink: 0;
    background-color: #f0f0f0;
}

/* CONTENT AREA */
.card-content {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    min-height: 120px;
}

.card-title {
    font-size: 1.25rem;
    font-weight: 800;
    color: #333;
    margin-bottom: 5px;
    text-decoration: none;
}
.card-meta {
    font-size: 0.85rem;
    color: #888;
    font-weight: 600;
    margin-bottom: 10px;
}
.card-preview {
    font-size: 0.95rem;
    color: #555;
    margin-bottom: 15px;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* BUTTONS */
.action-btn {
    padding: 6px 18px;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 700;
    color: white;
    border: none;
    text-decoration: none;
    display: inline-block;
    transition: opacity 0.2s;
    margin-right: 8px;
    cursor: pointer;
}
.action-btn:hover { opacity: 0.9; color: white; }

.btn-green { background-color: var(--lg-green-btn); } /* View/Continue */
.btn-blue { background-color: var(--lg-blue-btn); }   /* Edit */
.btn-red { background-color: var(--lg-red-btn); }     /* Delete */

/* Empty State */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #999;
}
.empty-icon { font-size: 3rem; margin-bottom: 15px; opacity: 0.5; }

/* Responsive */
@media (max-width: 768px) {
    .story-manage-card { flex-direction: column; }
    .card-thumb { width: 100%; height: 180px; }
}


/* Back Button ‚Äì same as view story */
.back-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  background-color: #e8f5e9;
  color: #2e7d32;
  font-weight: 700;
  border-radius: 999px;
  text-decoration: none;
  margin-bottom: 16px;
}

.back-btn:hover {
  background-color: #c8e6c9;
  color: #1b5e20;
  transform: translateX(-2px);
}

.back-btn,
.back-btn:hover,
.back-btn:focus,
.back-btn:active {
  text-decoration: none !important;
}

</style>

<div class="manage-wrapper">
    <div class="container">
      <a href="{{ url_for('story.index') }}" class="back-btn">
        <i class="fa-solid fa-arrow-left"></i> Back to Home
      </a>

        
        <h1 class="page-title">My Stories</h1>
        <p class="page-subtitle">View your posted stories and drafts.</p>

        <ul class="nav nav-pills" id="manageTabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link {% if active_tab != 'drafts' %}active{% endif %}" id="pills-posted-tab" data-bs-toggle="pill" data-bs-target="#pills-posted" type="button">Posted Stories</button>
            </li>
            <li class="nav-item">
                <button class="nav-link {% if active_tab == 'drafts' %}active{% endif %}" id="pills-drafts-tab" data-bs-toggle="pill" data-bs-target="#pills-drafts" type="button">Drafts</button>
            </li>
        </ul>

        <div class="tab-content" id="manageTabsContent">
            
            <div class="tab-pane fade {% if active_tab != 'drafts' %}show active{% endif %}" id="pills-posted" role="tabpanel">
                {% if stories %}
                    {% for s in stories %}
                    <div class="story-manage-card">
                        <img src="{{ url_for('static', filename='uploads/' ~ (s.image_path or 'logo.jpeg')) }}"
     class="card-thumb" alt="Story Image">

                        
                        <div class="card-content">
                            <div>
                                <h3 class="card-title">{{ s.title }}</h3>
                                <div class="card-meta">
                                    Posted on {{ s.created_at[:10] }}
                                    <span class="badge text-white {% if s.status == 'approved' %}bg-success{% elif s.status == 'pending' %}bg-warning text-dark{% else %}bg-danger{% endif %} ms-2">
                                        {{ s.status|capitalize }}
                                    </span>

                                </div> 
                                <p class="card-preview">{{ s.content }}</p>
                            </div>
                            
                            <div>
                                <a href="{{ url_for('story.view_story', story_id=s.id) }}" class="action-btn btn-green">View</a>
                                <button class="action-btn btn-blue" disabled title="Edit coming soon" style="opacity: 0.6; cursor: not-allowed;">Edit</button> 
                                <button class="action-btn btn-red" onclick="openDeleteStoryModal('{{ s.id }}')">Delete</button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">üì≠</div>
                        <h4>No posted stories yet.</h4>
                        <p>Go to "Create Story" to share your first memory!</p>
                    </div>
                {% endif %}
            </div>

            <div class="tab-pane fade {% if active_tab == 'drafts' %}show active{% endif %}" id="pills-drafts" role="tabpanel">
                {% if drafts %}
                    {% for d in drafts %}
                    <div class="story-manage-card" id="draft-card-{{ d.id }}">
                        <img src="{{ url_for('static', filename='uploads/' ~ (d.image_path or 'logo.jpeg')) }}" class="card-thumb" alt="Draft Image">
                        
                        <div class="card-content">
                            <div>
                                <h3 class="card-title">Draft: {{ d.title if d.title else "Untitled Draft" }}</h3>
                                <div class="card-meta">Last edited just now</div>
                                <p class="card-preview">{{ d.content if d.content else "No content yet..." }}</p>
                            </div>
                            
                            <div>
                                <a href="{{ url_for('story.edit_draft', draft_id=d.id) }}" class="action-btn btn-green">Continue Writing</a>
                                <button class="action-btn btn-red" onclick="openDeleteDraftModal({{ d.id }})">Delete Draft</button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">üìù</div>
                        <h4>No drafts saved.</h4>
                        <p>Start writing a story and save it for later!</p>
                    </div>
                {% endif %}
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="deleteStoryModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3" style="border-radius: 20px;">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold text-success w-100 text-center">Story Deletion Policy</h5>
      </div>
      <div class="modal-body">
        <form id="deleteStoryForm" method="POST" action="">
          <div class="mb-4">
            <label class="fw-bold small mb-1">Reason <span class="text-danger">*</span></label>
            <select name="reason_select" id="storyReasonSelect" class="form-select">
              <option value="">Choose a reason...</option>
              <option value="I don‚Äôt like it">I don‚Äôt like it</option>
              <option value="Nudity / sexual content">Nudity / sexual content</option>
              <option value="Hate speech / harassment">Hate speech / harassment</option>
              <option value="Spam / scam">Spam / scam</option>
              <option value="Violence / self-harm">Violence / self-harm</option>
              <option value="Other">Other</option>
            </select>
            <input type="text" name="reason_other" id="storyReasonOther" class="form-control mt-2" placeholder="If Other, please specify..." style="display:none;">
          </div>
          <div class="bg-light p-3 rounded-3 mb-3" style="font-size: 0.85rem; color: #333;">
            <div class="d-flex gap-2 mb-2"><i class="fa-solid fa-seedling text-success mt-1"></i><div><strong>1. Deleted stories cannot be recovered</strong><br><span class="text-muted small">Once removed, this story is permanently gone.</span></div></div>
            <div class="d-flex gap-2 mb-2"><i class="fa-solid fa-seedling text-success mt-1"></i><div><strong>2. Your water droplet earnings may decrease</strong><br><span class="text-muted small">Deleting a story can reduce your accumulated water.</span></div></div>
            <div class="d-flex gap-2 mb-2"><i class="fa-solid fa-seedling text-success mt-1"></i><div><strong>3. Future rewards may be affected</strong><br><span class="text-muted small">Some achievements depend on story history.</span></div></div>
            <div class="d-flex gap-2 mb-2"><i class="fa-solid fa-seedling text-success mt-1"></i><div><strong>4. Your garden growth may change</strong><br><span class="text-muted small">Plants grown from this story may be removed.</span></div></div>
            <div class="d-flex gap-2"><i class="fa-solid fa-seedling text-success mt-1"></i><div><strong>5. Irreversible action</strong><br><span class="text-muted small">This action cannot be undone.</span></div></div>
          </div>
          <div class="form-check mb-4">
            <input class="form-check-input" type="checkbox" id="agreeStoryCheck">
            <label class="form-check-label small text-muted" for="agreeStoryCheck">I understand that deleting this story is permanent.</label>
          </div>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-secondary w-50 py-2 fw-bold" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" id="confirmDeleteStoryBtn" class="btn btn-danger w-50 py-2 fw-bold" disabled>Delete Story</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="deleteDraftModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3" style="border-radius: 20px;">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold text-success w-100 text-center">Draft Deletion Policy</h5>
      </div>
      <div class="modal-body">
          <div class="mb-4">
            <label class="fw-bold small mb-1">Reason <span class="text-danger">*</span></label>
            <select id="draftReasonSelect" class="form-select">
              <option value="">Choose a reason...</option>
              <option value="I don‚Äôt like it">I don‚Äôt like it</option>
              <option value="Nudity / sexual content">Nudity / sexual content</option>
              <option value="Hate speech / harassment">Hate speech / harassment</option>
              <option value="Spam / scam">Spam / scam</option>
              <option value="Violence / self-harm">Violence / self-harm</option>
              <option value="Other">Other</option>
            </select>
            <input type="text" id="draftReasonOther" class="form-control mt-2" placeholder="If Other, please specify..." style="display:none;">
          </div>
          <div class="bg-light p-3 rounded-3 mb-3" style="font-size: 0.85rem; color: #333;">
            <div class="d-flex gap-2 mb-2"><i class="fa-solid fa-trash-can text-secondary mt-1"></i><div><strong>1. Deleted drafts cannot be recovered</strong><br><span class="text-muted small">Once deleted, this draft is gone.</span></div></div>
            <div class="d-flex gap-2 mb-2"><i class="fa-solid fa-file text-secondary mt-1"></i><div><strong>2. All unsaved content will be lost</strong><br><span class="text-muted small">Any text or photos will be erased.</span></div></div>
            <div class="d-flex gap-2"><i class="fa-solid fa-triangle-exclamation text-warning mt-1"></i><div><strong>3. This action is irreversible</strong><br><span class="text-muted small">We cannot retrieve deleted drafts.</span></div></div>
          </div>
          <div class="form-check mb-4">
            <input class="form-check-input" type="checkbox" id="agreeDraftCheck">
            <label class="form-check-label small text-muted" for="agreeDraftCheck">I understand that deleting this draft is permanent.</label>
          </div>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-secondary w-50 py-2 fw-bold" data-bs-dismiss="modal">Cancel</button>
            <button type="button" id="confirmDeleteDraftBtn" class="btn btn-danger w-50 py-2 fw-bold" disabled>Delete Draft</button>
          </div>
      </div>
    </div>
  </div>
</div>
<script>
  // --- STORY DELETION LOGIC ---
  function openDeleteStoryModal(storyId) {
    const form = document.getElementById('deleteStoryForm');
    form.action = "/story/delete/" + storyId; 
    
    // Reset inputs
    document.getElementById('agreeStoryCheck').checked = false;
    storyReasonSelect.value = "";
    storyReasonOther.value = "";
    storyReasonOther.style.display = "none"; 
    updateStoryDeleteButton(); // Force disable initially
    
    new bootstrap.Modal(document.getElementById('deleteStoryModal')).show();
  }

  // Get References
  const storyCheck = document.getElementById('agreeStoryCheck');
  const storyReasonSelect = document.getElementById('storyReasonSelect');
  const storyReasonOther = document.getElementById('storyReasonOther');
  const storyBtn = document.getElementById('confirmDeleteStoryBtn');
  
  // Logic: Enable button ONLY if Checkbox is True AND Reason is not empty
  function updateStoryDeleteButton() {
    const sel = (storyReasonSelect.value || '').trim();
    const other = (storyReasonOther.value || '').trim();
    const hasReason = sel && (sel !== 'Other' || other.length > 0);
    if (storyCheck.checked && hasReason) {
        storyBtn.disabled = false;
    } else {
        storyBtn.disabled = true;
    }
  }

  // Listen for changes
  storyCheck.addEventListener('change', updateStoryDeleteButton);
  storyReasonSelect.addEventListener('change', () => {
    storyReasonOther.style.display = (storyReasonSelect.value === 'Other') ? 'block' : 'none';
    updateStoryDeleteButton();
  });
  storyReasonOther.addEventListener('input', updateStoryDeleteButton);


  // --- DRAFT DELETION LOGIC ---
  let currentDraftIndex = null;
  function openDeleteDraftModal(index) {
    currentDraftIndex = index;
    
    // Reset inputs
    document.getElementById('agreeDraftCheck').checked = false;
    draftReasonSelect.value = "";
    draftReasonOther.value = "";
    draftReasonOther.style.display = "none";
    updateDraftDeleteButton(); // Force disable initially

    new bootstrap.Modal(document.getElementById('deleteDraftModal')).show();
  }

  const draftCheck = document.getElementById('agreeDraftCheck');
  const draftReasonSelect = document.getElementById('draftReasonSelect');
  const draftReasonOther = document.getElementById('draftReasonOther');
  const draftBtn = document.getElementById('confirmDeleteDraftBtn');

  function updateDraftDeleteButton() {
    const sel = (draftReasonSelect.value || '').trim();
    const other = (draftReasonOther.value || '').trim();
    const hasReason = sel && (sel !== 'Other' || other.length > 0);
    if (draftCheck.checked && hasReason) {
        draftBtn.disabled = false;
    } else {
        draftBtn.disabled = true;
    }
  }

  draftCheck.addEventListener('change', updateDraftDeleteButton);
  draftReasonSelect.addEventListener('change', () => {
    draftReasonOther.style.display = (draftReasonSelect.value === 'Other') ? 'block' : 'none';
    updateDraftDeleteButton();
  });
  draftReasonOther.addEventListener('input', updateDraftDeleteButton);

  // Handle Draft Deletion via Fetch (AJAX)
  draftBtn.addEventListener('click', function() {
      if (currentDraftIndex === null) return;
      
      // Send Delete Request
      const reasonFinal = (draftReasonSelect.value === 'Other') ? (draftReasonOther.value || '').trim() : (draftReasonSelect.value || '').trim();
      const fd = new FormData();
      fd.append('reason', reasonFinal);
      fetch(`/story/draft/${currentDraftIndex}/delete`, { method: 'POST', body: fd })
        .then(res => res.json())
        .then(data => {
            if(data.ok) {
                // Close Modal & UI Cleanup
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteDraftModal'));
                modal.hide();
                const card = document.getElementById(`draft-card-${currentDraftIndex}`);
                if(card) card.remove();
                if(document.querySelectorAll('[id^="draft-card-"]').length === 0) location.reload();
            }
        });
  });
</script>
{% endblock %}