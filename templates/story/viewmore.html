{% extends "base.html" %}
{% block title %}{{ story.title }} - Legacy Garden{% endblock %}

{% block content %}
<style>
  :root { --lg-green: #2e7d32; --lg-bg: #f9f5f0; }
  
  /* Report Modal Styles */
  .report-header { background-color: #e8f5e9; padding: 20px; border-radius: 15px 15px 0 0; }
  .report-body { background-color: #e8f5e9; padding: 20px; border-radius: 0 0 15px 15px; }
  .btn-report-submit { background-color: #dc3545; color: white; font-weight: bold; border-radius: 8px; width: 100px; }
  .btn-report-submit:disabled { background-color: #e6aeb3; cursor: not-allowed; }

  .story-hero {
  height: 650px;        
  object-fit: cover;
  display: block;
}


.back-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  background-color: #e8f5e9;
  color: #2e7d32;
  font-weight: 700;
  border-radius: 999px;
  text-decoration: none;
  margin-bottom: 12px;   
}


.back-btn:hover {
  background-color: #c8e6c9;
  color: #1b5e20;
  transform: translateX(-2px);
}

.back-btn,
.back-btn:hover,
.back-btn:focus,
.back-btn:active {
  text-decoration: none !important;
}

.story-actions{
  display:flex;
  align-items:center;
  justify-content:flex-end;
  gap:18px;
  flex-wrap:nowrap;
}

.action-btn,
.action-link{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding: 6px 8px;
  border-radius: 10px;
  line-height: 1;
  text-decoration: none;
}

.action-btn{
  border:0;
  background:transparent;
  cursor:pointer;
}

.story-actions i{
  font-size: 1.35rem;
  line-height: 1;
  display:block;
}

.action-btn i{ color:#dc3545; }
.action-link i{ color:#198754; }

.count-text{
  font-size: 0.95rem;
  font-weight: 800;
  color:#6c757d;
}

.action-btn:active,
.action-link:active{
  transform: scale(1.08);
}
.comment-top{
  display:flex;
  align-items:center;
  gap: 8px;
  margin-bottom: 6px;
}
.comment-report-btn{
  margin-left: auto;   
  border:0;
  background:transparent;
  color:#dc3545;
  padding: 2px 6px;
  border-radius: 8px;
  cursor:pointer;
  opacity: 0.6;
}

.comment-report-btn:hover{
  background: rgba(220,53,69,0.08);
  opacity: 1;
}
/* =========================
   REPORT MODAL (Nicer UI)
   ========================= */

/* modal container rounding */
.report-modal .modal-content{
  border-radius: 22px !important;
  overflow: hidden;
  box-shadow: 0 18px 50px rgba(0,0,0,0.18);
}

/* header */
.report-header{
  background: #eaf7ee;
  padding: 18px 20px;
  border-bottom: 1px solid rgba(46,125,50,0.10);

  display:flex;
  align-items:center;
  justify-content:center;
  gap: 10px;
  position: relative;
}

.report-header h5{
  margin: 0;
  font-weight: 800;
  color: #2e7d32;
  letter-spacing: 0.2px;
}

/* back icon */
.report-back{
  position:absolute;
  left: 16px;
  top: 50%;
  transform: translateY(-50%);
  width: 38px;
  height: 38px;
  border-radius: 12px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  color: #1b5e20;
  opacity: 0.85;
}

.report-back:hover{
  background: rgba(46,125,50,0.10);
  opacity: 1;
}

/* body */
.report-body{
  background: #eaf7ee;
  padding: 18px 20px 22px;
}

/* “card” inside modal */
.report-box{
  background: #ffffff;
  border: 1px solid rgba(46,125,50,0.10);
  border-radius: 18px;
  padding: 18px;
  box-shadow: 0 10px 26px rgba(0,0,0,0.05);
}


.report-label{
  font-weight: 800;
  font-size: 0.9rem;
  color: #1f1f1f;
  margin-bottom: 8px;
}

/* textarea */
/* input/select base */
.report-input{
  width: 100%;
  border: 1px solid #e9ecef;
  background: #f8faf9;
  border-radius: 16px;
  padding: 12px 14px;
  outline: none;
  transition: box-shadow .15s ease, border-color .15s ease, background .15s ease;
}

/* select should NOT be huge */
.report-select{
  height: 54px;
  padding: 10px 14px;
  font-weight: 700;
  color: #2b2b2b;
}

/* textarea */
.report-text{
  min-height: 110px;
  resize: none;
}

/* focus */
.report-input:focus{
  border-color: rgba(46,125,50,0.35);
  box-shadow: 0 0 0 5px rgba(46,125,50,0.12);
  background: #ffffff;
}




/* checkbox row */
.report-check{
  display:flex;
  gap: 10px;
  align-items:flex-start;
  margin: 14px 2px 18px;
  color:#5f6b63;
  font-size: 0.88rem;
}

.report-check input{
  margin-top: 3px;
}

/* submit button */
.btn-report-submit{
  background: #dc3545;
  color: #fff;
  border: none;
  font-weight: 800;
  padding: 10px 18px;
  border-radius: 12px;
  min-width: 120px;
  transition: transform .12s ease, opacity .12s ease;
}

.btn-report-submit:hover{
  transform: translateY(-1px);
}

.btn-report-submit:disabled{
  opacity: 0.45;
  cursor: not-allowed;
}

/* small animation on open */
.report-modal .modal-dialog{
  animation: popIn .18s ease;
}
@keyframes popIn{
  from { transform: translateY(10px); opacity: 0; }
  to   { transform: translateY(0); opacity: 1; }
}

.report-check{
  max-width: 380px;        /* keep it compact */
  margin: 12px auto 18px; /* ⬅️ centers the whole row */
  padding-left: 10px;    /* small nudge so it doesn’t feel too tight */
  line-height: 1.45;
}

/* Move select dropdown arrow to the LEFT */
.report-textarea.form-select{
  background-position: left 14px center;   /* move arrow left */
  padding-left: 42px;                      /* make space for arrow */
  padding-right: 12px;                     /* normal right padding */
}

/* Optional: flip the arrow direction (if you want it pointing left) */
.report-textarea.form-select{
  background-image: var(--bs-form-select-bg-img);
  background-repeat: no-repeat;
}

</style>

<div class="container mt-2 mb-5">
  <div class="container story-page-wrap">
    <a href="{{ url_for('story.index') }}" class="back-btn">
      <i class="fa-solid fa-arrow-left"></i> Back to Home
    </a>
  <div class="row">
    <div class="col-12">
      <div class="card story-card-full border-0 overflow-hidden">
        
        <img 
            src="{% if story.image_path %}{{ url_for('static', filename='uploads/' + story.image_path) }}{% else %}{{ url_for('static', filename='uploads/logo.jpeg') }}{% endif %}" 
            class="w-100 story-hero"
            alt="{{ story.title }}">


        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <h1 class="fw-bold mb-1">{{ story.title }}</h1>
              <p class="text-muted mb-0 small">
              Posted by
	            <a href="/view_profile/{{ story.username }}"
	                class="text-success fw-bold text-decoration-none d-inline-flex align-items-center gap-1">
	                {{ story.username }}
              </a>
                <span class="badge bg-light text-dark border ms-2">{{ story.topic }}</span>
              </p>
            </div>
            {% if session.get("user_id") != story.user_id %}
            <button class="btn btn-outline-danger btn-sm rounded-pill px-3" data-bs-toggle="modal" data-bs-target="#reportModal">
              <i class="fa-regular fa-flag"></i> Report
            </button>
            {% endif %}

          </div>

<div class="story-text" style="line-height: 1.8; font-size: 1.1rem; color: #444;">
  {{ story.content }}
</div>

<div class="story-actions mt-3">
  <button
    type="button"
    class="action-btn js-like-btn"
    data-story-id="{{ story.id }}"
    data-liked="{{ 1 if story.user_liked else 0 }}"
    aria-label="Like story"
  >
    <i class="{% if story.user_liked %}fa-solid{% else %}fa-regular{% endif %} fa-heart"></i>
    <span class="count-text js-like-count">{{ story.like_count or 0 }}</span>
  </button>

  <a href="#comments" class="action-link" aria-label="Jump to comments">
    <i class="fa-regular fa-comment"></i>
    <span class="count-text">{{ comments|length }}</span>
  </a>
</div>

<hr class="my-4">


<h4 id="comments" class="fw-bold mb-3">Comments ({{ comments|length }})</h4>
          
          {% for c in comments %}
          <div class="d-flex align-items-start mb-3" id="commentRow-{{ c.id }}">

            <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-4"
     style="width:40px; height:40px; flex-shrink:0;">

              	<a href="/view_profile/{{ c.username }}"
                    class="bg-light rounded-circle d-flex align-items-center justify-content-center text-decoration-none"
                    style="width:40px; height:40px; flex-shrink:0;">
                    <i class="fa-solid fa-user text-muted"></i>
                </a>
            </div>
          <div>
            <div class="bg-light px-3 py-2 rounded-3">
  <div class="d-flex align-items-center justify-content-between mb-1">
  <div class="d-flex align-items-center gap-2">
    <a href="/view_profile/{{ c.username }}"
       class="small text-success fw-bold text-decoration-none">
      {{ c.username }}
    </a>
  </div>

  {% if session.get("user_id") == c.user_id or session.get("user_id") == story.user_id %}
    <button type="button"
            class="btn btn-sm p-0 border-0 bg-transparent text-danger js-delete-comment"
            data-comment-id="{{ c.id }}"
            aria-label="Delete comment">
      <i class="fa-solid fa-trash"></i>
    </button>
  {% else %}
    <button type="button"
            class="btn btn-sm p-0 border-0 bg-transparent text-danger js-open-comment-report"
            data-comment-id="{{ c.id }}"
            aria-label="Report comment">
      <i class="fa-regular fa-flag"></i>
    </button>
  {% endif %}
</div>


  <span class="text-dark">{{ c.content }}</span>
</div>

              <small class="text-muted ms-1" style="font-size: 0.75rem;">{{ c.created_at[:10] }}</small>
            </div>
          </div>
          {% else %}
          <p class="text-muted fst-italic">No comments yet. Be the first to share your thoughts!</p>
          {% endfor %}
  


<form id="commentForm" action="{{ url_for('story.add_comment', story_id=story.id) }}" method="POST" class="mt-4">

  <div class="input-group">
    <input id="commentInput" type="text" name="content" class="form-control"
           placeholder="Write a heartwarming comment..." required maxlength="280" autocomplete="off">
    <button id="commentSubmitBtn" class="btn btn-success fw-bold" type="submit">Post</button>
  </div>
  <div id="commentErr" class="mt-2" style="display:none; color:#dc3545; font-weight:700;"></div>
  <div id="commentValid" class="mt-1" style="display:none; font-weight:700;"></div>

</form>



        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade report-modal" id="reportModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0">

      <div class="report-header">
        <div class="report-back" data-bs-dismiss="modal" aria-label="Close">
          <i class="fa-solid fa-arrow-left"></i>
        </div>
        <h5>Report Form</h5>
      </div>

      <div class="report-body">
        <form id="reportForm">
          <div class="report-box mb-3">
            <div class="report-label">Report Reason</div>
            <select id="reportReason" class="form-select report-input report-select mb-2">

  <option value="">Select a reason</option>
  <option value="explicit_content">Explicit / inappropriate content</option>
  <option value="harassment">Harassment / hate speech</option>
  <option value="spam">Spam / scam</option>
  <option value="misinformation">False or misleading information</option>
  <option value="violence">Violence or harmful acts</option>
  <option value="other">Other (please specify)</option>
</select>

<textarea id="reportReasonOther"
  class="report-input report-text d-none"
  rows="3"
  placeholder="Please describe the issue..."></textarea>

          </div>

          <label class="report-check">
            <input class="form-check-input" type="checkbox" id="reportCheck">
            <span>I understand that making false reports may terminate my account or rewards.</span>
          </label>

          <div class="d-flex justify-content-end">
            <button type="submit" id="btnSubmitReport" class="btn-report-submit" disabled>
              Report
            </button>
          </div>
        </form>
      </div>

    </div>
  </div>
</div>


<div class="modal fade" id="reportSuccessModal" tabindex="-1" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center p-4 border-0" style="border-radius: 20px;">
      <h3 class="fw-bold text-success mb-2">Thank you for reporting!</h3>
      <p class="text-muted small mb-4">We have temporarily removed the story and will check on our end before making actions!</p>
      
      <div class="d-flex justify-content-center gap-4">
        <a href="{{ url_for('story.manage') }}" class="btn btn-dark rounded-pill px-4 btn-sm">My Garden</a>
        <a href="{{ url_for('story.index') }}" class="btn btn-warning text-white rounded-pill px-4 btn-sm fw-bold">Back To Home</a>
        <a href="#" class="btn btn-warning text-white rounded-pill px-4 btn-sm fw-bold" style="opacity: 0.5;">My Rewards</a>
      </div>

    </div>
  </div>
</div>
<div class="modal fade report-modal" id="commentReportModal" tabindex="-1">

  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0" style="border-radius: 15px; overflow: hidden;">
      
      <div class="report-header">
  <div class="report-back" data-bs-dismiss="modal" aria-label="Close">
    <i class="fa-solid fa-arrow-left"></i>
  </div>
  <h5>Report Comment</h5>
</div>


      <div class="report-body pt-0">
        <form id="commentReportForm">
          <input type="hidden" id="reportCommentId">

          <div class="mb-3 bg-white p-3 rounded-3 shadow-sm">
            <label class="fw-bold small mb-2 text-dark">Report Reason</label>
            <select id="commentReportReasonSelect" class="form-select report-input report-select mb-2">
  <option value="">Select a reason</option>
  <option value="explicit_content">Explicit / inappropriate content</option>
  <option value="harassment">Harassment / hate speech</option>
  <option value="spam">Spam / scam</option>
  <option value="misinformation">False or misleading information</option>
  <option value="violence">Violence or harmful acts</option>
  <option value="other">Other (please specify)</option>
</select>

<textarea
  id="commentReportReasonOther"
  class="report-input report-text d-none"

  rows="3"
  placeholder="Please describe the issue..."></textarea>

          </div>

          <div class="form-check mb-4">
            <input class="form-check-input" type="checkbox" id="commentReportCheck">
            <label class="form-check-label small text-muted" for="commentReportCheck">
              I understand that making false reports may terminate my account or rewards.
            </label>
          </div>

          <div id="commentReportErr" class="mb-2" style="display:none; color:#dc3545; font-weight:700;"></div>

          <div class="text-end">
            <button type="submit" id="btnSubmitCommentReport" class="btn btn-report-submit" disabled>
              Report
            </button>
          </div>
        </form>
      </div>

    </div>
  </div>
</div>

<script>
  // 1. Validation Logic (Reason + Checkbox = Button Enabled)
const reasonSelect = document.getElementById('reportReason');
const reasonOther  = document.getElementById('reportReasonOther');
const checkInput   = document.getElementById('reportCheck');
const submitBtn    = document.getElementById('btnSubmitReport');

const reportBox = document.querySelector("#reportForm .report-box");

const errorMsg = document.createElement('div');
errorMsg.style.color = "#dc3545";
errorMsg.style.fontSize = "0.85rem";
errorMsg.style.marginTop = "10px";
errorMsg.style.fontWeight = "bold";
errorMsg.style.display = "none";

reportBox.appendChild(errorMsg);


  function validateReport() {
  let hasReason = reasonSelect.value && reasonSelect.value !== "";

  // if "other", must fill textbox
  if (reasonSelect.value === "other") {
    hasReason = reasonOther.value.trim().length >= 5;
  }

  const isChecked = checkInput.checked;
  submitBtn.disabled = !(hasReason && isChecked);
}


  reasonSelect.addEventListener('change', () => {
  if (reasonSelect.value === "other") {
    reasonOther.classList.remove("d-none");
  } else {
    reasonOther.classList.add("d-none");
    reasonOther.value = "";
  }
  validateReport();
});

reasonOther.addEventListener('input', validateReport);
checkInput.addEventListener('change', validateReport);


  // 2. Handle Submission via AJAX
  document.getElementById('reportForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Disable button to prevent double click
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sending...';
    submitBtn.disabled = true;
    errorMsg.style.display = "none";

    const formData = new FormData();

let finalReason = reasonSelect.value;
if (reasonSelect.value === "other") {
  finalReason = "other: " + reasonOther.value.trim();
}

formData.append('reason', finalReason);


    fetch("{{ url_for('story.report_story', story_id=story.id) }}", {
      method: 'POST',
      body: formData
    })
    .then(r => r.json())
    .then(data => {
      if(data.ok) {
        // Success: Hide Report Modal & Show Success Modal
        const reportModal = bootstrap.Modal.getInstance(document.getElementById('reportModal'));
        reportModal.hide();
        const successModal = new bootstrap.Modal(document.getElementById('reportSuccessModal'));
        successModal.show();
      } else {
        // Validation Error (Gibberish / Bad Words)
        errorMsg.innerText = "❌ " + (data.msg || "Error reporting story.");
        errorMsg.style.display = "block";
        submitBtn.innerHTML = "Report";
        submitBtn.disabled = false; 
      }
    })
    .catch(err => {
       console.error(err);
       errorMsg.innerText = "❌ Connection error. Please try again.";
       errorMsg.style.display = "block";
       submitBtn.innerHTML = "Report";
       submitBtn.disabled = false;
    });
  });

async function toggleLike(btn) {
  const storyId = btn.dataset.storyId;
  const icon = btn.querySelector("i");
  const countEl = btn.querySelector(".js-like-count");

  btn.style.transform = "scale(1.15)";
  setTimeout(() => (btn.style.transform = ""), 120);

  const res = await fetch(`/story/${storyId}/like-toggle`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({})
  });

  const data = await res.json();
  if (!data.ok) return;

  countEl.textContent = data.like_count;

  if (data.liked) {
    icon.classList.remove("fa-regular");
    icon.classList.add("fa-solid");
    btn.dataset.liked = "1";
  } else {
    icon.classList.remove("fa-solid");
    icon.classList.add("fa-regular");
    btn.dataset.liked = "0";
  }
}

document.addEventListener("click", (e) => {
  const btn = e.target.closest(".js-like-btn");
  if (!btn) return;
  toggleLike(btn);
});

let commentReportModal;

document.addEventListener("DOMContentLoaded", () => {
  commentReportModal = new bootstrap.Modal(document.getElementById("commentReportModal"));
});

const crSelect = document.getElementById("commentReportReasonSelect");
const crOther  = document.getElementById("commentReportReasonOther");
const crCheck  = document.getElementById("commentReportCheck");
const crBtn    = document.getElementById("btnSubmitCommentReport");
const crErr    = document.getElementById("commentReportErr");
const crIdEl   = document.getElementById("reportCommentId");


function validateCommentReport(){
  let hasReason = crSelect.value && crSelect.value !== "";

  if (crSelect.value === "other") {
    hasReason = crOther.value.trim().length >= 5;
  }

  crBtn.disabled = !(hasReason && crCheck.checked);
  if (hasReason) crErr.style.display = "none";
}

crSelect.addEventListener("change", () => {
  if (crSelect.value === "other") {
    crOther.classList.remove("d-none");
  } else {
    crOther.classList.add("d-none");
    crOther.value = "";
  }
  validateCommentReport();
});

crOther.addEventListener("input", validateCommentReport);
crCheck.addEventListener("change", validateCommentReport);


// open modal when clicking a comment flag
document.addEventListener("click", (e) => {
  const btn = e.target.closest(".js-open-comment-report");
  if (!btn) return;

  crIdEl.value = btn.dataset.commentId;
  crSelect.value = "";
crOther.value = "";
crOther.classList.add("d-none");
crCheck.checked = false;
crErr.style.display = "none";
crBtn.disabled = true;


  commentReportModal.show();
});

// submit report
document.getElementById("commentReportForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  crBtn.disabled = true;
  crBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sending...';

  const formData = new FormData();

let finalReason = crSelect.value;
if (crSelect.value === "other") {
  finalReason = "other: " + crOther.value.trim();
}

formData.append("reason", finalReason);


  const commentId = crIdEl.value;

  try {
    const urlTpl = "{{ url_for('story.report_comment', comment_id=0) }}";
const url = urlTpl.replace("0", commentId);

const res = await fetch(url, {
  method: "POST",
  body: formData
});

    const data = await res.json();

    if (!data.ok) {
      crErr.textContent = "❌ " + (data.msg || "Error reporting comment.");
      crErr.style.display = "block";
      crBtn.innerHTML = "Report";
      validateCommentReport();
      return;
    }

    commentReportModal.hide();

  } catch (err) {
    console.error(err);
    crErr.textContent = "❌ Connection error. Please try again.";
    crErr.style.display = "block";
    crBtn.innerHTML = "Report";
    validateCommentReport();
  }
});

document.addEventListener("click", async (e) => {
  const btn = e.target.closest(".js-delete-comment");
  if (!btn) return;

  const commentId = btn.dataset.commentId;
  if (!commentId) return;

  if (!confirm("Delete this comment? This cannot be undone.")) return;

  btn.disabled = true;

  try {
    const res = await fetch(`/story/comment/delete/${commentId}`, {
      method: "POST",
      headers: { "X-Requested-With": "XMLHttpRequest" }
    });

    const data = await res.json();

    if (!data.ok) {
      btn.disabled = false;
      alert(data.msg || "Cannot delete this comment.");
      return;
    }

    const row = document.getElementById(`commentRow-${commentId}`);
    if (row) row.remove();

  } catch (err) {
    console.error(err);
    btn.disabled = false;
    alert("Connection error.");
  }
});

//comment input
const commentForm = document.getElementById("commentForm");
const commentInput = document.getElementById("commentInput");
const commentErr = document.getElementById("commentErr");
const commentValid = document.getElementById("commentValid");
const commentBtn = document.getElementById("commentSubmitBtn");

function showCommentErr(msg){
  commentErr.textContent = "❌ " + (msg || "Invalid comment.");
  commentErr.style.display = "block";
}
function clearCommentErr(){
  commentErr.textContent = "";
  commentErr.style.display = "none";
}

function setCommentValid(msg, type){
  if (!msg){
    commentValid.style.display = "none";
    commentValid.textContent = "";
    commentValid.style.color = "";
    return;
  }
  commentValid.style.display = "block";
  commentValid.textContent = msg;

  if (type === "danger") commentValid.style.color = "#dc3545";
  else if (type === "warning") commentValid.style.color = "#b26a00";
  else if (type === "success") commentValid.style.color = "#198754";
  else commentValid.style.color = "#0d6efd";
}


let moderateTimer = null;
let lastModerateText = "";
let isApproved = false;

async function moderateCommentTextLive(text){
  const t = (text || "").trim();
  if (!t){
    isApproved = false;
    setCommentValid("", "");
    commentBtn.disabled = true;
    return;
  }

  
  if (t.length < 2){
    isApproved = false;
    setCommentValid("Comment is too short (min 2 characters).", "danger");
    commentBtn.disabled = true;
    return;
  }

 
  if (t === lastModerateText) return;
  lastModerateText = t;

  setCommentValid("Checking for explicit content…", "info");
  commentBtn.disabled = true;

  try{
    const res = await fetch("{{ url_for('story.api_moderate_text') }}", {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-Requested-With": "XMLHttpRequest" },
      body: JSON.stringify({ text: t, min_len: 2 })
    });

    const data = await res.json();

    if (!data.ok){
      isApproved = false;
    
      if ((data.status || "") === "warning"){
        setCommentValid(data.msg || "Warning: random words or gibberish/keyboard detected.", "warning");
      } else {
        setCommentValid(data.msg || "Explicit content detected, please change.", "danger");
      }
      commentBtn.disabled = true;
      return;
    }

    // approved
    isApproved = true;
    setCommentValid("✅ Looks good.", "success");
    commentBtn.disabled = false;

  } catch(err){
    console.error(err);
    isApproved = false;
    setCommentValid("❌ Validation service unavailable. Try again.", "danger");
    commentBtn.disabled = true;
  }
}

if (commentForm){
  // start disabled until approved
  commentBtn.disabled = true;

  commentInput.addEventListener("input", () => {
    clearCommentErr();

    // debounce backend moderation
    clearTimeout(moderateTimer);
    moderateTimer = setTimeout(() => {
      moderateCommentTextLive(commentInput.value);
    }, 600);
  });

  commentForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const txt = (commentInput.value || "").trim();
    if (!txt){
      showCommentErr("Comment is required.");
      return;
    }

    // strict: must be approved before submit
    if (!isApproved){
      showCommentErr("❌ Please fix your comment before posting.");
      return;
    }

    commentBtn.disabled = true;
    const oldLabel = commentBtn.innerHTML;
    commentBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    try{
      const fd = new FormData(commentForm);

      const res = await fetch(commentForm.action, {
        method: "POST",
        headers: { "X-Requested-With": "XMLHttpRequest" },
        body: fd
      });

      const data = await res.json();

      if (!data.ok){
        showCommentErr(data.msg || "Please change your comment.");
        commentBtn.disabled = false;
        commentBtn.innerHTML = oldLabel;
        // sync UI with backend msg
        setCommentValid(data.msg || "Please change your comment.", "danger");
        isApproved = false;
        return;
      }

      window.location.reload();

    } catch(err){
      console.error(err);
      showCommentErr("Connection error. Please try again.");
      commentBtn.disabled = false;
      commentBtn.innerHTML = oldLabel;
    }
  });
}

</script>
{% endblock %}
