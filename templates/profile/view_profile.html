{% extends "base.html" %}
{% block title %}{{ profile['username'] }} | Profile{% endblock %}

{% block content %}
<style>
.profile-wrapper {
  min-height: 100vh;
  padding: 30px 0 100px;
}

.profile-card-bg {
  background:#fff;
  border-radius:20px;
  padding:30px;
}

.profile-inner {
  max-width:1100px;
  margin:auto;
}

.profile-pic{
  width: clamp(140px, 14vw, 220px);
  height: clamp(140px, 14vw, 220px);
  object-fit: cover;
  background-color:#E8F0EA;
  border: 2px solid #000;
}

.btn-outline-success{
  border-radius:20px;
  padding:6px 14px;
  font-weight:500;
}

.story-card{
  border-radius:16px;
  background:white;
  box-shadow:0 4px 15px rgba(0,0,0,0.05);
  padding:25px;
  margin-bottom:25px;
}

.story-image-left{
  width:220px;
  flex-shrink:0;
}

.story-thumb{
  width:100%;
  height:160px;
  object-fit:cover;
  border-radius:12px;
  background:#E8F0EA;
}

.story-content-right{
  padding-left:20px;
  display:flex;
  flex-direction:column;
  justify-content:center;
}

@media (max-width: 768px){
  .story-card{ flex-direction:column; }
  .story-image-left{ width:100%; margin-bottom:12px; }
  .story-content-right{ padding-left:0; }
}

.story-actions i{
  font-size: 1.1rem;
}

/* Container holding heart & comment */
.story-actions{
  display: flex;
  align-items: center;
  gap: 22px;              /* ‚¨ÖÔ∏è space BETWEEN heart & comment */
}

/* Each icon+count pair */
.action-btn,
/* Make comment count same color as like count */
.action-link,
.action-link:visited,
.action-link:hover,
.action-link:active {
  color: #6c757d !important; /* same grey as like number */
  text-decoration: none;
}

/* Ensure number itself stays grey */
.action-link .count-text {
  color: #6c757d !important;
}


/* üî• Remove border / focus ring from like button */
.action-btn{
  border: none !important;
  outline: none !important;
  background: transparent !important;
  box-shadow: none !important;
}

/* Remove focus outline when clicked / tabbed */
.action-btn:focus,
.action-btn:focus-visible,
.action-btn:active{
  outline: none !important;
  box-shadow: none !important;
}


/* --- FIX: if button is disabled, DON'T grey it out --- */
.action-btn:disabled{
  opacity: 1 !important;
  cursor: default;
}

.action-btn.is-static{
  pointer-events: none;   /* not clickable */
  opacity: 1;
}

/* FORCE icon colours everywhere */
.story-actions .fa-heart {
  color: #dc3545 !important;   /* red */
}

.story-actions .fa-comment {
  color: #198754 !important;   /* green */
}

/* Title */
.story-title{
  color: #1f3b57;      /* dark blue */
  font-weight: 800;
}

/* CATEGORY / POSTED BY line */
.meta-text{
  color: #8c8c8c;      /* soft grey */
  font-size: 0.9rem;
  font-weight: 600;
  text-transform: uppercase;
}

/* Category highlight */
.meta-highlight{
  color: #2e7d32;      /* Legacy green */
  font-weight: 700;
}

/* Body preview text */
.story-content p{
  color: #6b7280;      /* neutral grey */
}

/* Read More */
.read-link{
  color: #2e7d32;      /* Legacy green */
  font-weight: 700;
}
.read-link:hover{
  color: #1b5e20;
  text-decoration: none;
}


</style>

<div class="profile-wrapper">
  <div class="container">

    <!-- PROFILE CARD -->
    <div class="profile-inner profile-card-bg shadow-sm">
      <div class="row align-items-center">

        <!-- PROFILE PIC -->
        <div class="col-md-3 text-center">
          {% if profile['profile_pic'] and profile['profile_pic'] != 'profile_pic.png' %}
            <img src="{{ url_for('static', filename='uploads/' + profile['profile_pic']) }}"
                 class="rounded-circle profile-pic">
          {% else %}
            <img src="https://ui-avatars.com/api/?name={{ profile['username'] }}&background=random&size=150"
                 class="rounded-circle profile-pic">
          {% endif %}
        </div>

        <!-- PROFILE INFO -->
        <div class="col-md-9">

          <!-- HEADER ROW -->
          <div class="d-flex align-items-center justify-content-between">

            <h2 class="fw-bold mb-0">{{ profile['username'] }}</h2>

            {% if session.get('username') != profile['username'] %}
              <a href="/messages/{{ profile['username'] }}"
                 class="btn btn-outline-success btn-sm">
                <i class="fa-regular fa-comment"></i> Message
              </a>
            {% endif %}

          </div>

          <p class="text-muted mb-3">{{ profile['name'] }}</p>

          <p class="mb-1">
            <strong>Profile type:</strong> {{ profile['role'] }}
            {% if profile['show_region'] %}
              &nbsp;&nbsp;<strong>Region:</strong> {{ profile['region'] }}
            {% endif %}
          </p>

          {% if profile['show_email'] %}
            <p class="text-muted">
              <i class="fa-regular fa-envelope"></i> {{ profile['email'] }}
            </p>
          {% endif %}

          <p class="mt-3" style="max-width:600px;">
            <strong>Bio:</strong><br>
            {{ profile['bio'] if profile['bio'] else 'No bio shared.' }}
          </p>

        </div>
      </div>
    </div>

    <!-- STORIES -->
<div class="profile-inner">
  <hr class="my-5">
  <h4 class="fw-bold mb-4">Stories by {{ profile['username'] }}</h4>

  {% if stories and stories|length > 0 %}
    {% for story in stories %}
      <div class="card story-card border-0 mb-4 overflow-hidden">
        <div class="row g-0 align-items-stretch">

          <!-- LEFT IMAGE -->
          <div class="col-md-4 story-img-col">
            {% set img = (story.image_path or '')|trim %}
            <img
              src="{% if img %}{{ url_for('static', filename='uploads/' + img) }}{% else %}{{ url_for('static', filename='uploads/logo.jpeg') }}{% endif %}"
              class="story-img"
              alt="{{ story.title }}"
            >
          </div>

          <!-- RIGHT CONTENT -->
          <div class="col-md-8">
            <div class="story-content">
              <h3 class="story-title mb-1">{{ story.title }}</h3>

              <div class="meta-text mb-3">
                CATEGORY: <span class="meta-highlight">{{ story.topic }}</span>
                ‚Ä¢ POSTED BY {{ profile['username']|upper }}
              </div>

              <p class="text-muted mb-3">
                {{ story.content[:120] }}{% if story.content|length > 120 %}...{% endif %}
              </p>

              <div class="d-flex justify-content-between align-items-center mt-auto">
                <a href="{{ url_for('story.view_story', story_id=story.id) }}" class="read-link">
                  Read More <i class="fa-solid fa-arrow-right"></i>
                </a>

                <div class="story-actions">
                  <button
                    type="button"
                    class="action-btn js-like-btn"
                    data-story-id="{{ story.id }}"
                    data-liked="{{ 1 if story.user_liked else 0 }}"
                    aria-label="Like story"
                  >
                    <i class="{% if story.user_liked %}fa-solid{% else %}fa-regular{% endif %} fa-heart"></i>
                    <span class="count-text js-like-count">{{ story.like_count or 0 }}</span>
                  </button>

                  <a href="{{ url_for('story.view_story', story_id=story.id) }}"
                     class="action-link"
                     aria-label="View comments">
                    <i class="fa-regular fa-comment"></i>
                    <span class="count-text">{{ story.comment_count or 0 }}</span>
                  </a>
                </div>

              </div>

            </div>
          </div>

        </div>
      </div>
    {% endfor %}
  {% else %}
    <p class="text-muted">No stories shared yet üå±</p>
  {% endif %}
</div>


<script>
async function toggleLike(btn) {
  const storyId = btn.dataset.storyId;
  const icon = btn.querySelector("i");
  const countEl = btn.querySelector(".js-like-count");

  btn.style.transform = "scale(1.15)";
  setTimeout(() => (btn.style.transform = ""), 120);

  const res = await fetch(`/story/${storyId}/like-toggle`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({})
  });

  const data = await res.json();
  if (!data.ok) return;

  countEl.textContent = data.like_count;

  if (data.liked) {
    icon.classList.remove("fa-regular");
    icon.classList.add("fa-solid");
    btn.dataset.liked = "1";
  } else {
    icon.classList.remove("fa-solid");
    icon.classList.add("fa-regular");
    btn.dataset.liked = "0";
  }
}

// event delegation (works even if cards reload)
document.addEventListener("click", (e) => {
  const btn = e.target.closest(".js-like-btn");
  if (!btn) return;
  toggleLike(btn);
});
</script>

{% endblock %}